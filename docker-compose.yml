version: '2'
services:

  web-client:
    image: node:9.3.0-alpine
    working_dir: /home/web-client
    command: yarn start
    volumes:
      - ./web-client:/home/web-client
      - ./web-client/node_modules:/home/web-client/node_modules:delegated
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=$NODE_ENV

  redis:
    image: redis:alpine
    ports:
      - 6379:6379

  thermometer-sensor:
    image: node:9.3.0-alpine
    working_dir: /home/thermometer-sensor
    command: yarn start
    volumes:
      - ./thermometer-sensor:/home/thermometer-sensor
      - ./thermometer-sensor/node_modules:/home/thermometer-sensor/node_modules:delegated
    depends_on:
      - redis
    ports:
      - '8080:8080'
    environment:
      - NODE_ENV=$NODE_ENV
      - PORT=$SENSOR_SERVER_PORT
      - NCHAN_URL=$NCHAN_URL
      - SENSOR_REDIS_URL=$SENSOR_REDIS_URL

  notification:
    image: meroje/alpine-nchan:latest
    working_dir: /home/notification
    volumes:
      - ./notification:/home/notification
    ports:
      - 9090:80
    volumes:
      - ./notification/nginx.conf:/etc/nginx/nginx.conf

  integration-tests:
    image: node:9.3.0-alpine
    working_dir: /home/integration-tests
    depends_on:
      - web-client
      - thermometer-sensor
      - notification
    volumes:
      - ./integration-tests:/home/integration-tests
      - ./integration-tests/node_modules:/home/integration-tests/node_modules:delegated
    environment:
      - NODE_ENV=$NODE_ENV
      - NCHAN_URL=$NCHAN_URL
      - SENSOR_URL=$SENSOR_URL
      - SENSOR_REDIS_URL=$SENSOR_REDIS_URL
